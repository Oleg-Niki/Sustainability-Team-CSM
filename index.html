<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>SIM Mateo - Clean Energy Exhibit</title>
    <!-- Include a decorative font for a classical look -->
    <link href="https://fonts.googleapis.com/css?family=Josefin+Sans&display=swap" rel="stylesheet">
    <style>
        /* ------------------------------
       Base Styles
       ------------------------------ */
        
        body {
            font-family: 'Josefin Sans', sans-serif;
            margin: 0;
            padding: 0;
            background: #e0f7fa;
            overflow-x: hidden;
            transition: background 0.5s;
        }
        
        header {
            position: fixed;
            top: 10px;
            right: 10px;
            background: url('assets/background.png') no-repeat center center;
            background-size: cover;
            z-index: 1000;
            display: none;
            /* Shown on instructions & interactive screens */
            border: none;
            /* Remove any default border if needed */
        }
        
        header button {
            padding: 15px 25px;
            font-size: 18px;
            background-color: #00796b;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.3s;
        }
        
        header button:hover {
            transform: scale(1.1);
            background-color: #004d40;
        }
        /* ------------------------------
       Start Screen
       ------------------------------ */
        
        #start-screen {
            position: relative;
            /* Establishes a positioning context */
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: url('assets/StartScreen.png') no-repeat center center;
            background-size: cover;
            text-align: center;
            animation: fadeIn 1s forwards;
        }
        
        #start-screen button {
            position: absolute;
            /* Positions the button relative to #start-screen */
            bottom: 40px;
            /* Adjust distance from the bottom */
            right: 40px;
            /* Adjust distance from the right */
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            /* Increased font size for a bigger appearance */
            padding: 25px 50px;
            /* Increased padding */
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        #start-screen button:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        /* ------------------------------
       Instruction Container
       ------------------------------ */
        
        #instruction-container {
            display: none;
            height: 100vh;
            background: #e0f7fa;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 1s forwards;
        }
        
        .instruction-screen {
            height: 100vh;
            width: 100%;
            position: relative;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .instruction-screen img {
            width: 100%;
            height: 100vh;
            object-fit: cover;
            margin: 0;
            padding: 0;
        }
        /* .instruction-screen p {
            font-size: 1.5rem;
            color: #333;
            margin: 10px 20px;
        } */
        
        #instruction-nav {
            position: relative;
            width: 100%;
            height: 0;
        }
        
        #instruction-back {
            left: 40px;
        }
        
        #instruction-next {
            right: 40px;
        }
        
        #instruction-nav button {
            position: absolute;
            bottom: 40px;
            font-family: 'Josefin Sans', sans-serif;
            font-size: 2.5rem;
            padding: 25px 50px;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        #instruction-nav button:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        /* ------------------------------
       Trying new class for instruction buttons
       ------------------------------ */
        
        .instruction-btn {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 2.5rem;
            padding: 25px 50px;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .instruction-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        /* ------------------------------
       Main Interactive Screen
       ------------------------------ */
        
        #main-screen {
            display: none;
            height: 100vh;
            overflow-y: auto;
            animation: fadeIn 0.5s forwards;
        }
        /* ------------------------------
       Controls: Add/Remove Card Buttons
       ------------------------------ */
        
        #controls {
            text-align: center;
            margin: 20px 0;
        }
        
        #controls button {
            font-size: 1.2rem;
            padding: 10px 20px;
            margin: 0 10px;
            /* The default background can be overridden by individual button styles below */
            background: linear-gradient(45deg, #26a69a, #00796b);
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        #controls button:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        /* Specific styles for each control button */
        
        #controls #add-card {
            background: #B0BD5E;
        }
        
        #controls #remove-card {
            background: #EA5F57;
        }
        /* ------------------------------
       Scenario Pages
       ------------------------------ */
        
        .scenario {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 60px;
            /* This pushes all the content down */
        }
        
        .transparent-overlay {
            position: absolute;
            top: 200px;
            /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            max-width: 80%;
            height: auto;
            opacity: 0.35;
        }
        
        #scenario1-page,
        #scenario2-page {
            height: calc(100vh - 80px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: url('assets/background.png') no-repeat center center;
            background-size: cover;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        #scenario1-page .scenario,
        #scenario2-page .scenario {
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
            background: #f1f8e9;
            border: 1px solid #c5e1a5;
            border-radius: 8px;
            text-align: left;
        }
        
        #scenario1-page h2,
        #scenario2-page h2 {
            color: #558b2f;
        }
        
        .cards-container {
            display: flex;
            justify-content: center;
            margin-top: 50px;
        }
        
        .card {
            width: 50px;
            height: 75px;
            border: 2px solid #555;
            margin: 5px;
            background: #EA5F57;
            border-radius: 4px;
            transition: background 0.3s, transform 0.3s;
        }
        
        .card.green {
            background: #B0BD5E;
            transform: scale(1.05);
        }
        
        .message {
            margin-top: 10px;
            font-weight: bold;
            color: #424242;
        }
        /* ------------------------------
       Scenario Navigation
       ------------------------------ */
        
        #scenario-nav {
            margin-top: 20px;
        }
        
        #scenario-nav button {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 2.5rem;
            padding: 25px 50px;
            background: linear-gradient(45deg, #ff8a00, #e52e71);
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin: 0 10px;
        }
        
        #scenario-nav button:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        /* ------------------------------
       Animations and Modal Styles
       ------------------------------ */
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .button-click {
            animation: pop 0.2s ease;
        }
        
        @keyframes pop {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            50% {
                transform: translateX(5px);
            }
            75% {
                transform: translateX(-5px);
            }
            100% {
                transform: translateX(0);
            }
        }
        
        #modal,
        #finalModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        
        #modal-content,
        #finalModalContent {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 350px;
            margin: 150px auto;
            text-align: center;
        }
        
        @media (max-width: 800px) {
            #start-screen h1 {
                font-size: 15vh;
            }
            .instruction-screen p {
                font-size: 1.2rem;
            }
            #scenario1-page .scenario,
            #scenario2-page .scenario {
                width: 95%;
            }
        }
        
        @media (max-width: 1024px) {
            #instruction-nav button {
                font-size: 2rem;
                /* Reduce font size */
                padding: 15px 30px;
                /* Reduce padding */
            }
        }
    </style>
</head>

<body>
    <!-- Header with Restart button (visible on instructions and interactive screens) -->
    <header id="header">
        <button id="restart-button">Restart</button>
    </header>

    <!-- Start Screen -->
    <div id="start-screen">
        <!--<h1>WELCOME TO SIM MATEO</h1>-->
        <button id="start-button">START</button>
    </div>

    <!-- Instruction Container -->
    <div id="instruction-container">
        <!-- Instruction Screen 1 -->
        <div id="instruction-screen-1" class="instruction-screen">
            <img src="assets/instructions1.png" alt="Instruction 1">
            <!-- <p>Each green card represents 10% of clean electricity.</p> -->
        </div>
        <!-- Instruction Screen 2 -->
        <div id="instruction-screen-2" class="instruction-screen">
            <img src="assets/instructions2.png" alt="Instruction 2">
            <!-- <p>Each red card represents 10% of traditional carbon‑intensive energy.</p> -->
        </div>
        <!-- Instruction Screen 3 -->
        <div id="instruction-screen-3" class="instruction-screen">
            <img src="assets/instructions3.png" alt="Instruction 3">
            <!-- <p>Tap each card on SIM Mateo's generator to visualize the amount of clean electricity the area is using.</p> -->
        </div>
        <!-- Navigation for instructions -->
        <div id="instruction-nav">
            <button id="instruction-back">Back</button>
            <button id="instruction-next">Next</button>
        </div>
    </div>

    <!-- Main Interactive Screen -->
    <div id="main-screen">
        <!-- Controls: (Hidden now so website doesn't send commands) -->
        <div id="controls" style="display: none;">
            <button id="add-card">Green Card</button>
            <button id="remove-card">Red Card</button>
        </div>
        <!-- Win Animation -->
        <div id="extra-animation" style="display: none; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 10000;">
            <img src="assets/confetti.gif" alt="Extra Animation - confetti">
        </div>
        <div id="sunburst" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
            <img src="assets/sunburst.gif" alt="Sun Burst Animation">
        </div>
        <!-- Scenario 1 Page -->
        <div id="scenario1-page">
            <div class="scenario">
                <img src="assets/california.png" alt="Transparent California Overlay" class="transparent-overlay">
                <h2 style="text-align: center;">
                    TAKE A GUESS!? O_o
                </h2>
                <!-- Card containers with 10 separate card elements -->
                <div class="cards-container" id="cards-all">
                    <div class="card" id="card-a1"></div>
                    <div class="card" id="card-a2"></div>
                    <div class="card" id="card-c1"></div>
                    <div class="card" id="card-c2"></div>
                    <div class="card" id="card-d1"></div>
                    <div class="card" id="card-d2"></div>
                    <div class="card" id="card-d3"></div>
                    <div class="card" id="card-e1"></div>
                    <div class="card" id="card-e2"></div>
                    <div class="card" id="card-f1"></div>
                </div>
                <div class="message" id="message-ca"></div>
                <h2 style="text-align: center;">
                    What percentage of California's electricity is clean? (e.g. solar, hydro, wind, nuclear)
                </h2>
            </div>
            <!-- Back button and Next button commented out for now: -->
            <!-- <div id="scenario-nav">
                <button id="scenario1-back">Back</button>
                <button id="scenario1-next">Next</button>
            </div> -->
        </div>
        <!-- Scenario 2 Page (if needed; you can use a similar structure) -->
        <div id="scenario2-page" style="display: none;">
            <div class="scenario">
                <img src="assets/smc.png" alt="Transparent SMC Overlay" class="transparent-overlay">
                <!-- For Scenario 2, if you wish to have a similar layout -->
                <div class="cards-container" id="cards-all-sm">
                    <div class="card" id="card-a1-sm"></div>
                    <div class="card" id="card-a2-sm"></div>
                    <div class="card" id="card-c1-sm"></div>
                    <div class="card" id="card-c2-sm"></div>
                    <div class="card" id="card-d1-sm"></div>
                    <div class="card" id="card-d2-sm"></div>
                    <div class="card" id="card-d3-sm"></div>
                    <div class="card" id="card-e1-sm"></div>
                    <div class="card" id="card-e2-sm"></div>
                    <div class="card" id="card-f1-sm"></div>
                </div>
                <div class="message" id="message-sm"></div>
                <h2 style="text-align: center;">
                    What percentage of San Mateo County's electricity is clean?
                </h2>
            </div>
            <!-- Back button commented out for now: -->
            <!-- <div id="scenario-nav">
                <button id="scenario2-back">Back</button>
            </div> -->
        </div>
    </div>

    <!-- Modal for Scenario 1 congratulatory popup -->
    <div id="modal">
        <div id="modal-content">
            <h2>Congratulations!</h2>
            <p>Great job! Keep guessing the current state in San Mateo County!</p>
            <button id="modal-close">Close</button>
        </div>
    </div>

    <!-- Final Modal for congratulatory message -->
    <div id="finalModal">
        <div id="finalModalContent">
            <h2>Congratulations!</h2>
            <p>
                You have completed the challenge! Renewable energy is essential for a sustainable future. Clean energy reduces greenhouse gas emissions, improves air quality, and creates green jobs. Keep learning about renewable energy and help build a better tomorrow!
            </p>
            <button id="theEndButton">The End</button>
        </div>
    </div>

    <!-- THE END Screen -->
    <div id="theEndScreen" style="display: none;">
        <div id="theEndContent" style="text-align: center; padding: 20px;">
            <img src="assets/gameover.jpg" alt="Game Over" style="width: 100vw; height: 100vh; object-fit: cover;">
        </div>
    </div>


    <script>
        // Wrap all DOM-related code in a DOMContentLoaded callback
        document.addEventListener("DOMContentLoaded", function() {

            // ------------------------------
            // DOM Element References
            // ------------------------------
            const startButton = document.getElementById('start-button');
            const startScreen = document.getElementById('start-screen');
            const instructionContainer = document.getElementById('instruction-container');
            const instructionScreens = document.getElementsByClassName('instruction-screen');
            const instructionBack = document.getElementById('instruction-back');
            const instructionNext = document.getElementById('instruction-next');
            const mainScreen = document.getElementById('main-screen');
            const header = document.getElementById('header');
            const restartButton = document.getElementById('restart-button');
            const scenario1Page = document.getElementById('scenario1-page');
            // Define the Scenario 1 card container as cardsCA (using the correct id "cards-all")
            const cardsCA = document.getElementById('cards-all');
            // Correct the Scenario 2 card container using the id "cards-all-sm"
            const cardsSM = document.getElementById('cards-all-sm');
            const messageCA = document.getElementById('message-ca');
            const scenario1Next = document.getElementById('scenario1-next');
            const scenario2Page = document.getElementById('scenario2-page');
            const messageSM = document.getElementById('message-sm');
            const scenario2Back = document.getElementById('scenario2-back');
            const addCardButton = document.getElementById('add-card');
            const removeCardButton = document.getElementById('remove-card');
            const modal = document.getElementById('modal');
            const modalClose = document.getElementById('modal-close');
            const finalModal = document.getElementById('finalModal');
            const theEndScreen = document.getElementById('theEndScreen');
            const theEndButton = document.getElementById('theEndButton');

            if (theEndButton) {
                theEndButton.addEventListener('click', () => {
                    hideFinalModal();
                    showTheEndScreen();
                });
            } else {
                console.error("Element with ID 'theEndButton' not found.");
            }

            // ------------------------------
            // Helper: animateButton
            // ------------------------------
            /**
             * animateButton(button)
             *
             * Adds the "button-click" class to the button element to provide a pop animation,
             * then removes it after 200 milliseconds.
             *
             * @param {HTMLElement} button - The button element to animate.
             */
            function animateButton(button) {
                button.classList.add('button-click');
                setTimeout(function() {
                    button.classList.remove('button-click');
                }, 200);
            }

            // ------------------------------
            // Helper: animateElement
            // ------------------------------
            /**
             * animateElement(element, animationClass, duration)
             *
             * Adds the specified animation class to an element and removes it after the specified duration.
             *
             * @param {HTMLElement} element - The element to animate.
             * @param {string} animationClass - The CSS class that defines the animation.
             * @param {number} [duration=500] - The duration in milliseconds after which the class is removed.
             */
            function animateElement(element, animationClass, duration) {
                duration = duration || 500;
                element.classList.add(animationClass);
                setTimeout(function() {
                    element.classList.remove(animationClass);
                }, duration);
            }

            // ------------------------------
            // Sound Effects Setup
            // ------------------------------
            const clickSound = new Audio('assets/SoundWindowsNavigationStart.wav');
            const scenarioCASound_Start = new Audio('assets/05-California.mp3');
            const scenarioCASound_30 = new Audio('assets/SoundScenarioCA_30.mp3');
            const scenarioCASound_win = new Audio('assets/SoundScenarioCA_win.mp3');
            const scenarioSMCSound_Start = new Audio('assets/SoundScenarioSMC_Start.mp3');
            const scenarioSMCSound_70 = new Audio('assets/SoundScenarioSMC_70.mp3');
            const scenarioSMCSound_win = new Audio('assets/SoundScenarioSMC_win.mp3');
            const wrongSound = new Audio('assets/SoundWindowsCriticalStop.mp3');
            const welcomeSound = new Audio('assets/01-Welcome.mp3');
            const instruction1Sound = new Audio('assets/02-Green Card.mp3');
            const instruction2Sound = new Audio('assets/03-Red Card.mp3');
            const instruction3Sound = new Audio('assets/04-Tap.mp3');
            const winSound = new Audio('assets/Tada_final.mp3');
            const wrongWrongSound = new Audio('assets/SoundWindowsCriticalWarning.mp3');

            // ------------------------------
            // Global Variables and DOM References
            // ------------------------------

            let socket;
            let instructionSoundTimer;
            let currentSound = null; // Variable to track the currently playing sound
            let cardCount = 0; // Progress variable: Scenario 1 starts at 0
            let currentInstruction = 1;
            const totalInstructions = 3;
            let consecutiveRedCount = 0; //count consecutive red cards
            let milestone30Played = false;
            let milestone56Played = false;
            let milestone70Played = false;
            let milestone100Played = false;


            // ------------------------------
            // WebSocket Integration
            // ------------------------------
            socket = new WebSocket("ws://localhost:80");
            socket.onopen = () => {
                console.log("Connected to SIM Mateo WebSocket server");
            };
            // Update the onmessage handler so that it updates card container colors.
            socket.onmessage = (event) => {
                console.log("Received from Arduino:", event.data);

                let rawMsg = event.data.trim();
                console.log("Raw message:", rawMsg);

                // Strip any prefix like "FROM NANO ..." if present.
                if (rawMsg.toLowerCase().includes("from nano")) {
                    const colonIndex = rawMsg.indexOf(":");
                    if (colonIndex !== -1) {
                        rawMsg = rawMsg.substring(colonIndex + 1).trim();
                    }
                }
                console.log("Processed message after prefix removal:", rawMsg);

                const message = rawMsg.toLowerCase();
                const regex = /^(a1|a2|c1|c2|d1|d2|d3|e1|e2|f1)_(green|red)$/i;
                const match = message.match(regex);
                if (!match) {
                    console.warn("Ignoring non-command message:", message);
                    return;
                }

                const board = match[1].toLowerCase();
                const color = match[2].toLowerCase();
                console.log(`Parsed command: board = ${board}, color = ${color}`);

                // Choose the correct card element based on which scenario is visible.
                let cardId;
                if (scenario1Page.style.display !== 'none') {
                    cardId = "card-" + board;
                } else if (scenario2Page.style.display !== 'none') {
                    cardId = "card-" + board + "-sm";
                }
                const cardElement = document.getElementById(cardId);
                if (!cardElement) {
                    console.error("No card element found with id:", cardId);
                    return;
                }

                if (color === "green") {
                    cardElement.classList.add("green");
                    playSound(clickSound)
                    consecutiveRedCount = 0;
                    console.log(`Added "green" class to ${cardId}`);
                } else {
                    cardElement.classList.remove("green");
                    consecutiveRedCount += 1;
                    console.log(`Removed "green" class from ${cardId}`);
                    if (consecutiveRedCount > 3) {
                        playSound(wrongWrongSound); // 4th+ straight red
                    } else {
                        playSound(wrongSound); // 1st–3rd red
                    }
                }

                // Update overall progress, which then calls updateUI.
                updateProgress();
            };


            // ------------------------------
            // Board Command Configuration for Sequential Command Sending
            // ------------------------------
            const boardCommands = ["A1", "A2", "C1", "C2", "D1", "D2", "D3", "E1", "E2", "F1"];
            let boardIndex = 0;

            /**
             * sendCommand(color)
             *
             * Constructs a command string using the current board identifier from boardCommands
             * and the provided color ("green" or "red"). The command is prefixed with the expected
             * "FROM NANO X:" string, where X is the board letter (derived from the board identifier).
             * The command is then sent via WebSocket to the Node.js server.
             *
             * @param {string} color - The LED color command ("green" or "red").
             */
            //function sendCommand(color) {
            //    // Get the current board command (e.g., "A1")
            //    const boardCmd = boardCommands[boardIndex];
            //    // Derive the board letter (first character)
            //    const boardLetter = boardCmd.charAt(0);
            //    // Construct the full command string
            //    const command = "FROM NANO " + boardLetter + ": " + boardCmd + "_" + color.toUpperCase();
            //    socket.send(command);
            //    console.log("Sent command:", command);
            //    boardIndex = (boardIndex + 1) % boardCommands.length;
            //}
            // ------------------------------
            // Sound managment: playSound(newSound)
            // ------------------------------

            function playSound(newSound) {
                // Pause and reset the current sound if it's playing
                if (currentSound && !currentSound.paused) {
                    currentSound.pause();
                    currentSound.currentTime = 0;
                }
                // Set and play the new sound, and catch any errors if the play is interrupted
                currentSound = newSound;
                const playPromise = newSound.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        // Optionally log the error or simply ignore it
                        console.error("Audio play error:", error);
                    });
                }
            }



            // ------------------------------
            // UI Update Functions
            // ------------------------------
            function updateProgress() {
                let greenCards = 0;

                // When Scenario 1 is active, count the green cards in "#cards-all"
                if (scenario1Page.style.display !== 'none') {
                    greenCards = document.querySelectorAll("#cards-all .card.green").length;
                }
                // When Scenario 2 is active, count the green cards in "#cards-all-sm"
                else if (scenario2Page.style.display !== 'none') {
                    greenCards = document.querySelectorAll("#cards-all-sm .card.green").length;
                }

                cardCount = greenCards;
                console.log("Updated cardCount:", cardCount);

                // If Scenario 1 is active and we've reached exactly 5 green cards,
                // automatically switch to Scenario 2 after 5 seconds.
                if (scenario1Page.style.display !== 'none' && cardCount === 5) {
                    setTimeout(() => {
                        // Double-check that we're still in Scenario 1 before switching.
                        if (scenario1Page.style.display !== 'none') {
                            console.log("Auto-switching to Scenario 2 now.");
                            scenario1Page.style.display = 'none';
                            scenario2Page.style.display = 'flex';
                            // Recreate Scenario 2's cards with unique IDs.
                            initializeScenario2Cards();
                        }
                    }, 5000); // Wait 5 seconds before switching.
                }

                // Now update the UI messages and animations based on the new cardCount.
                updateUI();
            }


            function initializeCards() {
                // Create cards in the container for Scenario 1 (with id 'cards-all')
                // Assume boardCommands is the array of board codes (e.g., ["A1", "A2", "C1", ...])
                if (cardsCA && cardsCA.innerHTML.trim() === "") {
                    boardCommands.forEach(boardCmd => {
                        const card = document.createElement('div');
                        card.classList.add('card');
                        // Set the id to lowercase, e.g., "card-a1"
                        card.id = "card-" + boardCmd.toLowerCase();
                        cardsCA.appendChild(card);
                    });
                }
            }

            function initializeScenario2Cards() {
                if (cardsSM) {
                    cardsSM.innerHTML = ''; // Clear any existing elements.
                    boardCommands.forEach(boardCmd => {
                        const card = document.createElement('div');
                        card.classList.add('card');
                        // Use a "-sm" suffix for Scenario 2 IDs, e.g., "card-a1-sm".
                        card.id = "card-" + boardCmd.toLowerCase() + "-sm";
                        // Optionally copy the green state from Scenario 1 (if needed):
                        let sourceCard = document.getElementById("card-" + boardCmd.toLowerCase());
                        if (sourceCard && sourceCard.classList.contains("green")) {
                            card.classList.add("green");
                        }
                        cardsSM.appendChild(card);
                    });
                }
            }


            function createCards(container) {
                // Assume boardCommands is the array of board codes in order:
                // ["A1", "A2", "C1", "C2", "D1", "D2", "D3", "E1", "E2", "F1"]
                container.innerHTML = ''; // Clear any existing elements
                boardCommands.forEach(boardCmd => {
                    // Create a new card element
                    const card = document.createElement('div');
                    card.classList.add('card');
                    // Set an id in lower case (e.g., "card-a1")
                    card.id = "card-" + boardCmd.toLowerCase();
                    container.appendChild(card);
                });
            }

            function updateUI() {
                // --- Scenario 1 (California) ---
                if (scenario1Page.style.display !== 'none') {
                    if (cardCount === 3 && !milestone30Played) {
                        messageCA.textContent = "California state has reached 30% clean energy by 1985!";
                        playSound(scenarioCASound_30);
                        animateElement(messageCA, 'button-click', 300);
                        milestone30Played = true;
                    } else if (cardCount === 5 && !milestone56Played) {
                        messageCA.textContent = "That’s right! California currently uses about 56% of clean electricity!";
                        // 1) play the initial “you won” (confetti) sound
                        playSound(winSound);

                        // 2) show the confetti animations
                        const sunburstEl = document.getElementById('sunburst');
                        const extraAnimationEl = document.getElementById('extra-animation');
                        sunburstEl.style.display = 'block';
                        extraAnimationEl.style.display = 'block';

                        // 3) after 2.8s hide them and play the CA‑win narration
                        setTimeout(() => {
                            sunburstEl.style.display = 'none';
                            extraAnimationEl.style.display = 'none';

                            playSound(scenarioCASound_win);

                            // 4) when that narration ends, wait 1s and then play the SMC‑start sound
                            scenarioCASound_win.addEventListener('ended', () => {
                                setTimeout(() => {
                                    playSound(scenarioSMCSound_Start);
                                }, 1000);
                            }, {
                                once: true
                            });

                        }, 1500);
                        // 5) still show your modal after a short delay
                        setTimeout(showModal, 500);
                        milestone56Played = true;
                    } else {
                        messageCA.textContent = "";
                    }
                }

                // --- Scenario 2 (San Mateo County) ---
                if (scenario2Page.style.display !== 'none') {
                    if (cardCount === 7) {
                        messageSM.textContent = "You’re getting close! San Mateo reached 75% clean electricity in 2016";
                        playSound(scenarioSMCSound_70);
                        animateElement(messageSM, 'button-click', 300);
                        milestone70Played = true;
                    } else if (cardCount === 10) {
                        messageSM.textContent = "You got it! San Mateo serves 100% clean electricity – leading the nation!";
                        playSound(scenarioSMCSound_win);
                        animateElement(messageSM, 'button-click', 300);
                        milestone100Played = true;
                        setTimeout(showFinalModal, 1000);
                    } else {
                        messageSM.textContent = "";
                    }
                }
            }

            // ------------------------------
            // Reset Function: Resets UI and Variables to Start State
            // ------------------------------
            function resetExhibit() {
                cardCount = 0;
                currentInstruction = 1;
                boardIndex = 0;
                instructionContainer.style.display = 'none';
                mainScreen.style.display = 'none';
                scenario1Page.style.display = 'none';
                scenario2Page.style.display = 'none';
                modal.style.display = 'none';
                finalModal.style.display = 'none';
                header.style.display = 'none';
                messageCA.textContent = "";
                messageSM.textContent = "";
                createCards(cardsCA, 0);
                createCards(cardsSM, 0);
                startScreen.style.display = 'flex';
                milestone30Played = false;
                milestone56Played = false;
                milestone70Played = false;
                milestone100Played = false;
            }

            // ------------------------------
            // Instruction Navigation Functions
            // ------------------------------
            function showInstructionScreen(index) {
                // Clear any pending instruction sound timer
                if (instructionSoundTimer) {
                    clearTimeout(instructionSoundTimer);
                    instructionSoundTimer = null;
                }

                currentInstruction = index;
                for (let i = 0; i < instructionScreens.length; i++) {
                    instructionScreens[i].style.display = 'none';
                }
                document.getElementById('instruction-screen-' + index).style.display = 'flex';
                instructionBack.style.display = (index === 1) ? 'none' : 'inline-block';
                instructionNext.textContent = (index === totalInstructions) ? 'Continue' : 'Next';

                // Play the corresponding instruction sound based on the screen index
                switch (index) {
                    case 1:
                        instructionSoundTimer = setTimeout(() => {
                            playSound(instruction1Sound);
                        }, 5200);
                        break;
                    case 2:
                        playSound(instruction2Sound);
                        break;
                    case 3:
                        playSound(instruction3Sound);
                        break;
                    default:
                        break;
                }
            }
            instructionBack.addEventListener('click', () => {
                animateButton(instructionBack);
                if (currentInstruction > 1) {
                    showInstructionScreen(currentInstruction - 1);
                }
            });
            instructionNext.addEventListener('click', () => {
                animateButton(instructionNext);
                if (currentInstruction < totalInstructions) {
                    showInstructionScreen(currentInstruction + 1);
                } else {
                    // Clear any pending instruction sound timer before moving on
                    if (instructionSoundTimer) {
                        clearTimeout(instructionSoundTimer);
                        instructionSoundTimer = null;
                    }
                    instructionContainer.style.display = 'none';
                    mainScreen.style.display = 'block';
                    showScenario1();
                    updateUI();
                }
            });

            // ------------------------------
            // Scenario Navigation Functions
            // ------------------------------
            function showScenario1() {
                scenario1Page.style.display = 'flex';
                scenario2Page.style.display = 'none';
                playSound(scenarioCASound_Start);
                initializeCards(); // Create cards only once if not already created.
            }

            function showScenario2() {
                scenario1Page.style.display = 'none';
                scenario2Page.style.display = 'flex';
            }

            // ------------------------------
            // Event Handlers
            // ------------------------------
            startButton.addEventListener('click', () => {
                animateButton(startButton);
                playSound(clickSound);
                playSound(welcomeSound);
                startScreen.style.display = 'none';
                header.style.display = 'block';
                instructionContainer.style.display = 'flex';
                showInstructionScreen(1);
            });
            scenario1Next.addEventListener('click', () => {
                animateButton(scenario1Next);
                playSound(clickSound);
                showScenario2();
            });
            scenario2Back.addEventListener('click', () => {
                animateButton(scenario2Back);
                playSound(clickSound);
                showScenario1();
            });

            addCardButton.addEventListener('click', () => {
                animateButton(addCardButton);
                playSound(clickSound);
                if (cardCount < 10) {
                    cardCount++;
                    updateUI();
                    // Send command via WebSocket for green card
                    sendCommand("green");
                }
            });
            const scenario1Back = document.getElementById('scenario1-back');

            scenario1Back.addEventListener('click', () => {
                animateButton(scenario1Back);
                playSound(clickSound);
                // Hide Scenario 1 and main interactive screen
                scenario1Page.style.display = 'none';
                mainScreen.style.display = 'none';
                // Show instruction container and jump to Instruction #3
                instructionContainer.style.display = 'flex';
                showInstructionScreen(totalInstructions);
            });


            removeCardButton.addEventListener('click', () => {
                animateButton(removeCardButton);
                playSound(wrongSound);
                if (cardCount > 0) {
                    cardCount--;
                    updateUI();
                    // Send command via WebSocket for red card
                    sendCommand("red");
                }
            });
            restartButton.addEventListener('click', resetExhibit);
            resetExhibit();

            // ------------------------------
            // Modal and Final Modal Handling
            // ------------------------------
            function showModal() {
                modal.style.display = 'block';
                setTimeout(hideModal, 2000);
            }

            function hideModal() {
                modal.style.display = 'none';
            }
            modalClose.addEventListener('click', () => {
                hideModal();
                // Automatic transition: if in Scenario 1, switch to Scenario 2 and play start sound.
                if (scenario1Page.style.display !== 'none') {
                    showScenario2();
                    playSound(scenarioSMCSound_Start);
                }
            });

            function showFinalModal() {
                finalModal.style.display = 'block';
            }

            function hideFinalModal() {
                finalModal.style.display = 'none';
            }

            // ------------------------------
            // sendCommand(color)
            // ------------------------------
            /**
             * Constructs a command string using the current board command from the boardCommands array
             * and the provided color ("green" or "red"). The command is prefixed with the expected
             * "FROM NANO X:" string (where X is the board letter derived from the board identifier)
             * and then sent via the WebSocket to the Node.js server, which forwards it to the Arduino.
             *
             * For example, if boardCommands[boardIndex] is "A1" and color is "green",
             * the function sends: "FROM NANO A: A1_GREEN".
             *
             * @param {string} color - The LED color command ("green" or "red").
             */
            function sendCommand(color) {
                // Get the current board command (for example, "A1")
                const boardCmd = boardCommands[boardIndex];
                // Prepend the "WEBSITE:" prefix to indicate the source.
                const command = "WEBSITE:" + boardCmd + "_" + color.toUpperCase();
                // Append a newline so Arduino's readStringUntil('\n') works as expected.
                // Delay sending the command 200 ms
                setTimeout(() => {
                    socket.send(command + "\n");
                    console.log("Sent command:", command);
                    boardIndex = (boardIndex + 1) % boardCommands.length;
                }, 200);
            }


            function showTheEndScreen() {
                mainScreen.style.display = 'none';
                scenario2Page.style.display = 'none';
                modal.style.display = 'none';
                finalModal.style.display = 'none';
                theEndScreen.style.display = 'block';
            }


            theEndButton.addEventListener('click', () => {
                hideFinalModal();
                showTheEndScreen();
            });
        });
    </script>
</body>

</html>